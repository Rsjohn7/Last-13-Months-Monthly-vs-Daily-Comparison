 -- *********************** DECEMBER 2020 DATA ******************************
SELECT PORTFOLIO_DATE_DAILY, DATA_FREQ_DAILY, PRODUCT_DAILY, QRM_ACCOUNT_DAILY,       
       CASE WHEN QRM_ACCOUNT_DAILY = 'Distressed Loans (HFS)' AND ROUND(FACE_AMT_MONTHLY,2) IS NULL
       THEN 0 ELSE ROUND(FACE_AMT_MONTHLY,2) END AS FACE_AMT_MONTHLY,       
       ROUND(FACE_AMT_DAILY,2) AS FACE_AMT_DAILY,      
       ROUND(BOOK_VALUE_MONTHLY,2) AS BOOK_VALUE_MONTHLY, ROUND(BOOK_VALUE_DAILY,2) AS BOOK_VALUE_DAILY, 
       (FACE_AMT_MONTHLY-BOOK_VALUE_MONTHLY) AS 'Prem/Disc (monthly)',
       (FACE_AMT_DAILY-BOOK_VALUE_DAILY) AS 'Prem/Disc (daily)',
        MTM_PRICE_WAVG_MONTHLY, MTM_PRICE_WAVG_DAILY, GROSS_WAC_WAVG_MONTHLY, GROSS_WAC_WAVG_DAILY,
        NET_WAC_WAVG_MONTHLY, NET_WAC_WAVG_DAILY, MARGIN_WAVG_MONTHLY, MARGIN_WAVG_DAILY,
--       ROUND(MTM_PRICE_MONTHLY,2) AS MTM_PRICE_MONTHLY, ROUND(MTM_PRICE_DAILY,2) AS MTM_PRICE_DAILY,
--       ROUND(GROSS_WAC_MONTHLY,2) AS GROSS_WAC_MONTHLY, ROUND(GROSS_WAC_DAILY,2) AS GROSS_WAC_DAILY,
--       ROUND(NET_WAC_MONTHLY,2) AS NET_WAC_MONTHLY, ROUND(NET_WAC_DAILY,2) AS NET_WAC_DAILY,
--       ROUND(MARGIN_MONTHLY,2) AS MARGIN_MONTHLY, ROUND(MARGIN_DAILY,2) AS MARGIN_DAILY,
      'DEC 2020' DATA_DATE

FROM 
(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Loans' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) /NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '01/04/2021'
 -- Always Choose Next Fannie Mae Business Day From the Calendar 
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Securities' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2020'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Debt' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY
FROM FNMA_QRM_DAILY_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2020'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Derivatives' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, CAST(' ' AS int) AS BOOK_VALUE_DAILY ,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2020'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'NMA' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2020'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) A

LEFT JOIN 

(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Loans' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '12/31/2020'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Securities' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2020'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Debt' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2020'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Derivatives' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, CAST(' ' AS int) AS BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2020'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'NMA' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2020'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) B
ON A.QRM_ACCOUNT_DAILY = B.QRM_ACCOUNT_MONTHLY
AND A.PRODUCT_DAILY = B.PRODUCT_MONTHLY

UNION ALL

 -- *********************** JANUARY 2021 DATA ******************************

SELECT PORTFOLIO_DATE_DAILY, DATA_FREQ_DAILY, PRODUCT_DAILY, QRM_ACCOUNT_DAILY,
       CASE WHEN QRM_ACCOUNT_DAILY = 'Distressed Loans (HFS)' AND ROUND(FACE_AMT_MONTHLY,2) IS NULL
       THEN 0 ELSE ROUND(FACE_AMT_MONTHLY,2) END AS FACE_AMT_MONTHLY,
       ROUND(FACE_AMT_DAILY,2) AS FACE_AMT_DAILY,      
       ROUND(BOOK_VALUE_MONTHLY,2) AS BOOK_VALUE_MONTHLY, ROUND(BOOK_VALUE_DAILY,2) AS BOOK_VALUE_DAILY, 
       (FACE_AMT_MONTHLY-BOOK_VALUE_MONTHLY) AS 'Prem/Disc (monthly)',
       (FACE_AMT_DAILY-BOOK_VALUE_DAILY) AS 'Prem/Disc (daily)',
       MTM_PRICE_WAVG_MONTHLY, MTM_PRICE_WAVG_DAILY, GROSS_WAC_WAVG_MONTHLY, GROSS_WAC_WAVG_DAILY,
       NET_WAC_WAVG_MONTHLY, NET_WAC_WAVG_DAILY, MARGIN_WAVG_MONTHLY, MARGIN_WAVG_DAILY,
--       ROUND(MTM_PRICE_MONTHLY,2) AS MTM_PRICE_MONTHLY, ROUND(MTM_PRICE_DAILY,2) AS MTM_PRICE_DAILY,
--       ROUND(GROSS_WAC_MONTHLY,2) AS GROSS_WAC_MONTHLY, ROUND(GROSS_WAC_DAILY,2) AS GROSS_WAC_DAILY,
--       ROUND(NET_WAC_MONTHLY,2) AS NET_WAC_MONTHLY, ROUND(NET_WAC_DAILY,2) AS NET_WAC_DAILY,
--       ROUND(MARGIN_MONTHLY,2) AS MARGIN_MONTHLY, ROUND(MARGIN_DAILY,2) AS MARGIN_DAILY,
       'JAN 2021' DATA_DATE

FROM 
(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Loans' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '02/01/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Securities' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '01/29/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Debt' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '01/29/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Derivatives' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, CAST(' ' AS int) AS BOOK_VALUE_DAILY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '01/29/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'NMA' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '01/29/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) A

LEFT JOIN 

(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Loans' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '01/29/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Securities' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '01/29/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Debt' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '01/29/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Derivatives' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, CAST(' ' AS int) AS BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '01/29/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'NMA' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '01/29/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) B
ON A.QRM_ACCOUNT_DAILY = B.QRM_ACCOUNT_MONTHLY
AND A.PRODUCT_DAILY = B.PRODUCT_MONTHLY

 -- *********************** FEBRUARY 2021 DATA ******************************
UNION ALL

SELECT PORTFOLIO_DATE_DAILY, DATA_FREQ_DAILY, PRODUCT_DAILY, QRM_ACCOUNT_DAILY,
       CASE WHEN QRM_ACCOUNT_DAILY = 'Distressed Loans (HFS)' AND ROUND(FACE_AMT_MONTHLY,2) IS NULL
       THEN 0 ELSE ROUND(FACE_AMT_MONTHLY,2) END AS FACE_AMT_MONTHLY,
       ROUND(FACE_AMT_DAILY,2) AS FACE_AMT_DAILY,      
       ROUND(BOOK_VALUE_MONTHLY,2) AS BOOK_VALUE_MONTHLY, ROUND(BOOK_VALUE_DAILY,2) AS BOOK_VALUE_DAILY, 
       (FACE_AMT_MONTHLY-BOOK_VALUE_MONTHLY) AS 'Prem/Disc (monthly)',
       (FACE_AMT_DAILY-BOOK_VALUE_DAILY) AS 'Prem/Disc (daily)',
       MTM_PRICE_WAVG_MONTHLY, MTM_PRICE_WAVG_DAILY, GROSS_WAC_WAVG_MONTHLY, GROSS_WAC_WAVG_DAILY,
       NET_WAC_WAVG_MONTHLY, NET_WAC_WAVG_DAILY, MARGIN_WAVG_MONTHLY, MARGIN_WAVG_DAILY,
--       ROUND(MTM_PRICE_MONTHLY,2) AS MTM_PRICE_MONTHLY, ROUND(MTM_PRICE_DAILY,2) AS MTM_PRICE_DAILY,
--       ROUND(GROSS_WAC_MONTHLY,2) AS GROSS_WAC_MONTHLY, ROUND(GROSS_WAC_DAILY,2) AS GROSS_WAC_DAILY,
--       ROUND(NET_WAC_MONTHLY,2) AS NET_WAC_MONTHLY, ROUND(NET_WAC_DAILY,2) AS NET_WAC_DAILY,
--       ROUND(MARGIN_MONTHLY,2) AS MARGIN_MONTHLY, ROUND(MARGIN_DAILY,2) AS MARGIN_DAILY,
       'FEB 2021' DATA_DATE

FROM 
(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Loans' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '03/01/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Securities' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '02/26/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Debt' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '02/26/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Derivatives' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, CAST(' ' AS int) AS BOOK_VALUE_DAILY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '02/26/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'NMA' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '02/26/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) A

LEFT JOIN 

(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Loans' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '02/26/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Securities' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '02/26/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Debt' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '02/26/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Derivatives' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, CAST(' ' AS int) AS BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '02/26/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'NMA' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '02/26/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) B
ON A.QRM_ACCOUNT_DAILY = B.QRM_ACCOUNT_MONTHLY
AND A.PRODUCT_DAILY = B.PRODUCT_MONTHLY

 -- *********************** MARCH 2021 DATA ******************************
UNION ALL

SELECT PORTFOLIO_DATE_DAILY, DATA_FREQ_DAILY, PRODUCT_DAILY, QRM_ACCOUNT_DAILY,
       CASE WHEN QRM_ACCOUNT_DAILY = 'Distressed Loans (HFS)' AND ROUND(FACE_AMT_MONTHLY,2) IS NULL
       THEN 0 ELSE ROUND(FACE_AMT_MONTHLY,2) END AS FACE_AMT_MONTHLY,
       ROUND(FACE_AMT_DAILY,2) AS FACE_AMT_DAILY,      
       ROUND(BOOK_VALUE_MONTHLY,2) AS BOOK_VALUE_MONTHLY, ROUND(BOOK_VALUE_DAILY,2) AS BOOK_VALUE_DAILY, 
       (FACE_AMT_MONTHLY-BOOK_VALUE_MONTHLY) AS 'Prem/Disc (monthly)',
       (FACE_AMT_DAILY-BOOK_VALUE_DAILY) AS 'Prem/Disc (daily)',
       MTM_PRICE_WAVG_MONTHLY, MTM_PRICE_WAVG_DAILY, GROSS_WAC_WAVG_MONTHLY, GROSS_WAC_WAVG_DAILY,
       NET_WAC_WAVG_MONTHLY, NET_WAC_WAVG_DAILY, MARGIN_WAVG_MONTHLY, MARGIN_WAVG_DAILY,
--       ROUND(MTM_PRICE_MONTHLY,2) AS MTM_PRICE_MONTHLY, ROUND(MTM_PRICE_DAILY,2) AS MTM_PRICE_DAILY,
--       ROUND(GROSS_WAC_MONTHLY,2) AS GROSS_WAC_MONTHLY, ROUND(GROSS_WAC_DAILY,2) AS GROSS_WAC_DAILY,
--       ROUND(NET_WAC_MONTHLY,2) AS NET_WAC_MONTHLY, ROUND(NET_WAC_DAILY,2) AS NET_WAC_DAILY,
--       ROUND(MARGIN_MONTHLY,2) AS MARGIN_MONTHLY, ROUND(MARGIN_DAILY,2) AS MARGIN_DAILY,
       'MAR 2021' DATA_DATE

FROM 
(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Loans' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '04/01/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Securities' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '03/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Debt' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '03/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Derivatives' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, CAST(' ' AS int) AS BOOK_VALUE_DAILY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '03/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'NMA' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '03/31/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) A

LEFT JOIN 

(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Loans' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '03/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Securities' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '03/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Debt' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '03/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Derivatives' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, CAST(' ' AS int) AS BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '03/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'NMA' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '03/31/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) B
ON A.QRM_ACCOUNT_DAILY = B.QRM_ACCOUNT_MONTHLY
AND A.PRODUCT_DAILY = B.PRODUCT_MONTHLY

 -- *********************** APRIL 2021 DATA ******************************
UNION ALL

SELECT PORTFOLIO_DATE_DAILY, DATA_FREQ_DAILY, PRODUCT_DAILY, QRM_ACCOUNT_DAILY,
       CASE WHEN QRM_ACCOUNT_DAILY = 'Distressed Loans (HFS)' AND ROUND(FACE_AMT_MONTHLY,2) IS NULL
       THEN 0 ELSE ROUND(FACE_AMT_MONTHLY,2) END AS FACE_AMT_MONTHLY,
       ROUND(FACE_AMT_DAILY,2) AS FACE_AMT_DAILY,      
       ROUND(BOOK_VALUE_MONTHLY,2) AS BOOK_VALUE_MONTHLY, ROUND(BOOK_VALUE_DAILY,2) AS BOOK_VALUE_DAILY, 
       (FACE_AMT_MONTHLY-BOOK_VALUE_MONTHLY) AS 'Prem/Disc (monthly)',
       (FACE_AMT_DAILY-BOOK_VALUE_DAILY) AS 'Prem/Disc (daily)',
       MTM_PRICE_WAVG_MONTHLY, MTM_PRICE_WAVG_DAILY, GROSS_WAC_WAVG_MONTHLY, GROSS_WAC_WAVG_DAILY,
       NET_WAC_WAVG_MONTHLY, NET_WAC_WAVG_DAILY, MARGIN_WAVG_MONTHLY, MARGIN_WAVG_DAILY,
--       ROUND(MTM_PRICE_MONTHLY,2) AS MTM_PRICE_MONTHLY, ROUND(MTM_PRICE_DAILY,2) AS MTM_PRICE_DAILY,
--       ROUND(GROSS_WAC_MONTHLY,2) AS GROSS_WAC_MONTHLY, ROUND(GROSS_WAC_DAILY,2) AS GROSS_WAC_DAILY,
--       ROUND(NET_WAC_MONTHLY,2) AS NET_WAC_MONTHLY, ROUND(NET_WAC_DAILY,2) AS NET_WAC_DAILY,
--       ROUND(MARGIN_MONTHLY,2) AS MARGIN_MONTHLY, ROUND(MARGIN_DAILY,2) AS MARGIN_DAILY,
       'APR 2021' DATA_DATE

FROM 
(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Loans' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '05/03/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Securities' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '04/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Debt' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '04/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Derivatives' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, CAST(' ' AS int) AS BOOK_VALUE_DAILY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '04/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'NMA' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '04/30/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) A

LEFT JOIN 

(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Loans' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '04/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Securities' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '04/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Debt' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '04/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Derivatives' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, CAST(' ' AS int) AS BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '04/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'NMA' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '04/30/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) B
ON A.QRM_ACCOUNT_DAILY = B.QRM_ACCOUNT_MONTHLY
AND A.PRODUCT_DAILY = B.PRODUCT_MONTHLY

 -- *********************** MAY 2021 DATA ******************************
UNION ALL

SELECT PORTFOLIO_DATE_DAILY, DATA_FREQ_DAILY, PRODUCT_DAILY, QRM_ACCOUNT_DAILY,
       CASE WHEN QRM_ACCOUNT_DAILY = 'Distressed Loans (HFS)' AND ROUND(FACE_AMT_MONTHLY,2) IS NULL
       THEN 0 ELSE ROUND(FACE_AMT_MONTHLY,2) END AS FACE_AMT_MONTHLY,
       ROUND(FACE_AMT_DAILY,2) AS FACE_AMT_DAILY,      
       ROUND(BOOK_VALUE_MONTHLY,2) AS BOOK_VALUE_MONTHLY, ROUND(BOOK_VALUE_DAILY,2) AS BOOK_VALUE_DAILY, 
       (FACE_AMT_MONTHLY-BOOK_VALUE_MONTHLY) AS 'Prem/Disc (monthly)',
       (FACE_AMT_DAILY-BOOK_VALUE_DAILY) AS 'Prem/Disc (daily)',
       MTM_PRICE_WAVG_MONTHLY, MTM_PRICE_WAVG_DAILY, GROSS_WAC_WAVG_MONTHLY, GROSS_WAC_WAVG_DAILY,
       NET_WAC_WAVG_MONTHLY, NET_WAC_WAVG_DAILY, MARGIN_WAVG_MONTHLY, MARGIN_WAVG_DAILY,
--       ROUND(MTM_PRICE_MONTHLY,2) AS MTM_PRICE_MONTHLY, ROUND(MTM_PRICE_DAILY,2) AS MTM_PRICE_DAILY,
--       ROUND(GROSS_WAC_MONTHLY,2) AS GROSS_WAC_MONTHLY, ROUND(GROSS_WAC_DAILY,2) AS GROSS_WAC_DAILY,
--       ROUND(NET_WAC_MONTHLY,2) AS NET_WAC_MONTHLY, ROUND(NET_WAC_DAILY,2) AS NET_WAC_DAILY,
--       ROUND(MARGIN_MONTHLY,2) AS MARGIN_MONTHLY, ROUND(MARGIN_DAILY,2) AS MARGIN_DAILY,
       'MAY 2021' DATA_DATE

FROM 
(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Loans' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '06/01/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Securities' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '05/28/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Debt' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '05/28/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Derivatives' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, CAST(' ' AS int) AS BOOK_VALUE_DAILY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '05/28/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'NMA' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '05/28/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) A

LEFT JOIN 

(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Loans' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '05/28/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Securities' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '05/28/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Debt' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '05/28/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Derivatives' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, CAST(' ' AS int) AS BOOK_VALUE_MONTHLY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '05/28/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'NMA' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '05/28/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) B
ON A.QRM_ACCOUNT_DAILY = B.QRM_ACCOUNT_MONTHLY
AND A.PRODUCT_DAILY = B.PRODUCT_MONTHLY

 -- *********************** JUNE 2021 DATA ******************************
UNION ALL

SELECT PORTFOLIO_DATE_DAILY, DATA_FREQ_DAILY, PRODUCT_DAILY, QRM_ACCOUNT_DAILY,
       CASE WHEN QRM_ACCOUNT_DAILY = 'Distressed Loans (HFS)' AND ROUND(FACE_AMT_MONTHLY,2) IS NULL
       THEN 0 ELSE ROUND(FACE_AMT_MONTHLY,2) END AS FACE_AMT_MONTHLY,
       ROUND(FACE_AMT_DAILY,2) AS FACE_AMT_DAILY,      
       ROUND(BOOK_VALUE_MONTHLY,2) AS BOOK_VALUE_MONTHLY, ROUND(BOOK_VALUE_DAILY,2) AS BOOK_VALUE_DAILY, 
       (FACE_AMT_MONTHLY-BOOK_VALUE_MONTHLY) AS 'Prem/Disc (monthly)',
       (FACE_AMT_DAILY-BOOK_VALUE_DAILY) AS 'Prem/Disc (daily)',
       MTM_PRICE_WAVG_MONTHLY, MTM_PRICE_WAVG_DAILY, GROSS_WAC_WAVG_MONTHLY, GROSS_WAC_WAVG_DAILY,
       NET_WAC_WAVG_MONTHLY, NET_WAC_WAVG_DAILY, MARGIN_WAVG_MONTHLY, MARGIN_WAVG_DAILY,
--       ROUND(MTM_PRICE_MONTHLY,2) AS MTM_PRICE_MONTHLY, ROUND(MTM_PRICE_DAILY,2) AS MTM_PRICE_DAILY,
--       ROUND(GROSS_WAC_MONTHLY,2) AS GROSS_WAC_MONTHLY, ROUND(GROSS_WAC_DAILY,2) AS GROSS_WAC_DAILY,
--       ROUND(NET_WAC_MONTHLY,2) AS NET_WAC_MONTHLY, ROUND(NET_WAC_DAILY,2) AS NET_WAC_DAILY,
--       ROUND(MARGIN_MONTHLY,2) AS MARGIN_MONTHLY, ROUND(MARGIN_DAILY,2) AS MARGIN_DAILY,
       'JUN 2021' DATA_DATE

FROM 
(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Loans' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '07/01/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Securities' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '06/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Debt' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '06/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Derivatives' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, CAST(' ' AS int) AS BOOK_VALUE_DAILY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '06/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'NMA' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '06/30/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) A

LEFT JOIN 

(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Loans' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '06/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Securities' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '06/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Debt' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '06/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Derivatives' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, CAST(' ' AS int) AS BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '06/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'NMA' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '06/30/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) B
ON A.QRM_ACCOUNT_DAILY = B.QRM_ACCOUNT_MONTHLY
AND A.PRODUCT_DAILY = B.PRODUCT_MONTHLY

 -- *********************** JULY 2021 DATA ******************************
UNION ALL

SELECT PORTFOLIO_DATE_DAILY, DATA_FREQ_DAILY, PRODUCT_DAILY, QRM_ACCOUNT_DAILY,
       CASE WHEN QRM_ACCOUNT_DAILY = 'Distressed Loans (HFS)' AND ROUND(FACE_AMT_MONTHLY,2) IS NULL
       THEN 0 ELSE ROUND(FACE_AMT_MONTHLY,2) END AS FACE_AMT_MONTHLY,
       ROUND(FACE_AMT_DAILY,2) AS FACE_AMT_DAILY,      
       ROUND(BOOK_VALUE_MONTHLY,2) AS BOOK_VALUE_MONTHLY, ROUND(BOOK_VALUE_DAILY,2) AS BOOK_VALUE_DAILY, 
       (FACE_AMT_MONTHLY-BOOK_VALUE_MONTHLY) AS 'Prem/Disc (monthly)',
       (FACE_AMT_DAILY-BOOK_VALUE_DAILY) AS 'Prem/Disc (daily)',
       MTM_PRICE_WAVG_MONTHLY, MTM_PRICE_WAVG_DAILY, GROSS_WAC_WAVG_MONTHLY, GROSS_WAC_WAVG_DAILY,
       NET_WAC_WAVG_MONTHLY, NET_WAC_WAVG_DAILY, MARGIN_WAVG_MONTHLY, MARGIN_WAVG_DAILY,
--       ROUND(MTM_PRICE_MONTHLY,2) AS MTM_PRICE_MONTHLY, ROUND(MTM_PRICE_DAILY,2) AS MTM_PRICE_DAILY,
--       ROUND(GROSS_WAC_MONTHLY,2) AS GROSS_WAC_MONTHLY, ROUND(GROSS_WAC_DAILY,2) AS GROSS_WAC_DAILY,
--       ROUND(NET_WAC_MONTHLY,2) AS NET_WAC_MONTHLY, ROUND(NET_WAC_DAILY,2) AS NET_WAC_DAILY,
--       ROUND(MARGIN_MONTHLY,2) AS MARGIN_MONTHLY, ROUND(MARGIN_DAILY,2) AS MARGIN_DAILY,
       'JUL 2021' DATA_DATE

FROM 
(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Loans' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '08/02/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Securities' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '07/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Debt' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '07/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Derivatives' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, CAST(' ' AS int) AS BOOK_VALUE_DAILY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '07/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'NMA' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '07/30/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) A

LEFT JOIN 

(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Loans' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '07/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Securities' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '07/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Debt' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '07/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Derivatives' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, CAST(' ' AS int) AS BOOK_VALUE_MONTHLY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '07/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'NMA' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '07/30/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) B
ON A.QRM_ACCOUNT_DAILY = B.QRM_ACCOUNT_MONTHLY
AND A.PRODUCT_DAILY = B.PRODUCT_MONTHLY

 -- *********************** AUGUST 2021 DATA ******************************
UNION ALL

SELECT PORTFOLIO_DATE_DAILY, DATA_FREQ_DAILY, PRODUCT_DAILY, QRM_ACCOUNT_DAILY,
       CASE WHEN QRM_ACCOUNT_DAILY = 'Distressed Loans (HFS)' AND ROUND(FACE_AMT_MONTHLY,2) IS NULL
       THEN 0 ELSE ROUND(FACE_AMT_MONTHLY,2) END AS FACE_AMT_MONTHLY,
       ROUND(FACE_AMT_DAILY,2) AS FACE_AMT_DAILY,      
       ROUND(BOOK_VALUE_MONTHLY,2) AS BOOK_VALUE_MONTHLY, ROUND(BOOK_VALUE_DAILY,2) AS BOOK_VALUE_DAILY, 
       (FACE_AMT_MONTHLY-BOOK_VALUE_MONTHLY) AS 'Prem/Disc (monthly)',
       (FACE_AMT_DAILY-BOOK_VALUE_DAILY) AS 'Prem/Disc (daily)',
       MTM_PRICE_WAVG_MONTHLY, MTM_PRICE_WAVG_DAILY, GROSS_WAC_WAVG_MONTHLY, GROSS_WAC_WAVG_DAILY,
       NET_WAC_WAVG_MONTHLY, NET_WAC_WAVG_DAILY, MARGIN_WAVG_MONTHLY, MARGIN_WAVG_DAILY,
--       ROUND(MTM_PRICE_MONTHLY,2) AS MTM_PRICE_MONTHLY, ROUND(MTM_PRICE_DAILY,2) AS MTM_PRICE_DAILY,
--       ROUND(GROSS_WAC_MONTHLY,2) AS GROSS_WAC_MONTHLY, ROUND(GROSS_WAC_DAILY,2) AS GROSS_WAC_DAILY,
--       ROUND(NET_WAC_MONTHLY,2) AS NET_WAC_MONTHLY, ROUND(NET_WAC_DAILY,2) AS NET_WAC_DAILY,
--       ROUND(MARGIN_MONTHLY,2) AS MARGIN_MONTHLY, ROUND(MARGIN_DAILY,2) AS MARGIN_DAILY,
       'AUG 2021' DATA_DATE

FROM 
(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Loans' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '09/01/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Securities' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '08/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Debt' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '08/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Derivatives' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, CAST(' ' AS int) AS BOOK_VALUE_DAILY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '08/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'NMA' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '08/31/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) A

LEFT JOIN 

(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Loans' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '08/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Securities' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '08/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Debt' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '08/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Derivatives' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, CAST(' ' AS int) AS BOOK_VALUE_MONTHLY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '08/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'NMA' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '08/31/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) B
ON A.QRM_ACCOUNT_DAILY = B.QRM_ACCOUNT_MONTHLY
AND A.PRODUCT_DAILY = B.PRODUCT_MONTHLY

 -- *********************** SEPTEMBER 2021 DATA ******************************
UNION ALL

SELECT PORTFOLIO_DATE_DAILY, DATA_FREQ_DAILY, PRODUCT_DAILY, QRM_ACCOUNT_DAILY,
       CASE WHEN QRM_ACCOUNT_DAILY = 'Distressed Loans (HFS)' AND ROUND(FACE_AMT_MONTHLY,2) IS NULL
       THEN 0 ELSE ROUND(FACE_AMT_MONTHLY,2) END AS FACE_AMT_MONTHLY,
       ROUND(FACE_AMT_DAILY,2) AS FACE_AMT_DAILY,      
       ROUND(BOOK_VALUE_MONTHLY,2) AS BOOK_VALUE_MONTHLY, ROUND(BOOK_VALUE_DAILY,2) AS BOOK_VALUE_DAILY, 
       (FACE_AMT_MONTHLY-BOOK_VALUE_MONTHLY) AS 'Prem/Disc (monthly)',
       (FACE_AMT_DAILY-BOOK_VALUE_DAILY) AS 'Prem/Disc (daily)',
       MTM_PRICE_WAVG_MONTHLY, MTM_PRICE_WAVG_DAILY, GROSS_WAC_WAVG_MONTHLY, GROSS_WAC_WAVG_DAILY,
       NET_WAC_WAVG_MONTHLY, NET_WAC_WAVG_DAILY, MARGIN_WAVG_MONTHLY, MARGIN_WAVG_DAILY,
--       ROUND(MTM_PRICE_MONTHLY,2) AS MTM_PRICE_MONTHLY, ROUND(MTM_PRICE_DAILY,2) AS MTM_PRICE_DAILY,
--       ROUND(GROSS_WAC_MONTHLY,2) AS GROSS_WAC_MONTHLY, ROUND(GROSS_WAC_DAILY,2) AS GROSS_WAC_DAILY,
--       ROUND(NET_WAC_MONTHLY,2) AS NET_WAC_MONTHLY, ROUND(NET_WAC_DAILY,2) AS NET_WAC_DAILY,
--       ROUND(MARGIN_MONTHLY,2) AS MARGIN_MONTHLY, ROUND(MARGIN_DAILY,2) AS MARGIN_DAILY,
       'SEP 2021' DATA_DATE

FROM 
(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Loans' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '10/01/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Securities' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '09/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Debt' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '09/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Derivatives' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, CAST(' ' AS int) AS BOOK_VALUE_DAILY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '09/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'NMA' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '09/30/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) A

LEFT JOIN 

(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Loans' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '09/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Securities' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '09/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Debt' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '09/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Derivatives' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, CAST(' ' AS int) AS BOOK_VALUE_MONTHLY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY


FROM FNMA_QRM_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '09/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'NMA' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '09/30/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) B
ON A.QRM_ACCOUNT_DAILY = B.QRM_ACCOUNT_MONTHLY
AND A.PRODUCT_DAILY = B.PRODUCT_MONTHLY

 -- *********************** OCTOBER 2021 DATA ******************************
UNION ALL

SELECT PORTFOLIO_DATE_DAILY, DATA_FREQ_DAILY, PRODUCT_DAILY, QRM_ACCOUNT_DAILY,
       CASE WHEN QRM_ACCOUNT_DAILY = 'Distressed Loans (HFS)' AND ROUND(FACE_AMT_MONTHLY,2) IS NULL
       THEN 0 ELSE ROUND(FACE_AMT_MONTHLY,2) END AS FACE_AMT_MONTHLY,
       ROUND(FACE_AMT_DAILY,2) AS FACE_AMT_DAILY,      
       ROUND(BOOK_VALUE_MONTHLY,2) AS BOOK_VALUE_MONTHLY, ROUND(BOOK_VALUE_DAILY,2) AS BOOK_VALUE_DAILY, 
       (FACE_AMT_MONTHLY-BOOK_VALUE_MONTHLY) AS 'Prem/Disc (monthly)',
       (FACE_AMT_DAILY-BOOK_VALUE_DAILY) AS 'Prem/Disc (daily)',
       MTM_PRICE_WAVG_MONTHLY, MTM_PRICE_WAVG_DAILY, GROSS_WAC_WAVG_MONTHLY, GROSS_WAC_WAVG_DAILY,
       NET_WAC_WAVG_MONTHLY, NET_WAC_WAVG_DAILY, MARGIN_WAVG_MONTHLY, MARGIN_WAVG_DAILY,
--       ROUND(MTM_PRICE_MONTHLY,2) AS MTM_PRICE_MONTHLY, ROUND(MTM_PRICE_DAILY,2) AS MTM_PRICE_DAILY,
--       ROUND(GROSS_WAC_MONTHLY,2) AS GROSS_WAC_MONTHLY, ROUND(GROSS_WAC_DAILY,2) AS GROSS_WAC_DAILY,
--       ROUND(NET_WAC_MONTHLY,2) AS NET_WAC_MONTHLY, ROUND(NET_WAC_DAILY,2) AS NET_WAC_DAILY,
--       ROUND(MARGIN_MONTHLY,2) AS MARGIN_MONTHLY, ROUND(MARGIN_DAILY,2) AS MARGIN_DAILY,
       'OCT 2021' DATA_DATE

FROM 
(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Loans' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '11/01/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Securities' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '10/29/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Debt' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '10/29/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Derivatives' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, CAST(' ' AS int) AS BOOK_VALUE_DAILY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '10/29/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'NMA' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '10/29/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) A

LEFT JOIN 

(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Loans' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '10/29/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Securities' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '10/29/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Debt' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '10/29/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Derivatives' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, CAST(' ' AS int) AS BOOK_VALUE_MONTHLY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '10/29/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'NMA' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '10/29/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) B
ON A.QRM_ACCOUNT_DAILY = B.QRM_ACCOUNT_MONTHLY
AND A.PRODUCT_DAILY = B.PRODUCT_MONTHLY

 -- *********************** NOVEMBER 2021 DATA ******************************
UNION ALL

SELECT PORTFOLIO_DATE_DAILY, DATA_FREQ_DAILY, PRODUCT_DAILY, QRM_ACCOUNT_DAILY,
       CASE WHEN QRM_ACCOUNT_DAILY = 'Distressed Loans (HFS)' AND ROUND(FACE_AMT_MONTHLY,2) IS NULL
       THEN 0 ELSE ROUND(FACE_AMT_MONTHLY,2) END AS FACE_AMT_MONTHLY,
       ROUND(FACE_AMT_DAILY,2) AS FACE_AMT_DAILY,      
       ROUND(BOOK_VALUE_MONTHLY,2) AS BOOK_VALUE_MONTHLY, ROUND(BOOK_VALUE_DAILY,2) AS BOOK_VALUE_DAILY, 
       (FACE_AMT_MONTHLY-BOOK_VALUE_MONTHLY) AS 'Prem/Disc (monthly)',
       (FACE_AMT_DAILY-BOOK_VALUE_DAILY) AS 'Prem/Disc (daily)',
       MTM_PRICE_WAVG_MONTHLY, MTM_PRICE_WAVG_DAILY, GROSS_WAC_WAVG_MONTHLY, GROSS_WAC_WAVG_DAILY,
       NET_WAC_WAVG_MONTHLY, NET_WAC_WAVG_DAILY, MARGIN_WAVG_MONTHLY, MARGIN_WAVG_DAILY,
--       ROUND(MTM_PRICE_MONTHLY,2) AS MTM_PRICE_MONTHLY, ROUND(MTM_PRICE_DAILY,2) AS MTM_PRICE_DAILY,
--       ROUND(GROSS_WAC_MONTHLY,2) AS GROSS_WAC_MONTHLY, ROUND(GROSS_WAC_DAILY,2) AS GROSS_WAC_DAILY,
--       ROUND(NET_WAC_MONTHLY,2) AS NET_WAC_MONTHLY, ROUND(NET_WAC_DAILY,2) AS NET_WAC_DAILY,
--       ROUND(MARGIN_MONTHLY,2) AS MARGIN_MONTHLY, ROUND(MARGIN_DAILY,2) AS MARGIN_DAILY,
       'NOV 2021' DATA_DATE

FROM 
(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Loans' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '12/01/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Securities' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '11/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Debt' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '11/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Derivatives' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, CAST(' ' AS int) AS BOOK_VALUE_DAILY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '11/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'NMA' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '11/30/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) A

LEFT JOIN 

(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Loans' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '11/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Securities' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '11/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Debt' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '11/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Derivatives' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, CAST(' ' AS int) AS BOOK_VALUE_MONTHLY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '11/30/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'NMA' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '11/30/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) B
ON A.QRM_ACCOUNT_DAILY = B.QRM_ACCOUNT_MONTHLY
AND A.PRODUCT_DAILY = B.PRODUCT_MONTHLY

 -- *********************** DECEMBER 2021 DATA ******************************
UNION ALL

SELECT PORTFOLIO_DATE_DAILY, DATA_FREQ_DAILY, PRODUCT_DAILY, QRM_ACCOUNT_DAILY,
       CASE WHEN QRM_ACCOUNT_DAILY = 'Distressed Loans (HFS)' AND ROUND(FACE_AMT_MONTHLY,2) IS NULL
       THEN 0 ELSE ROUND(FACE_AMT_MONTHLY,2) END AS FACE_AMT_MONTHLY,
       ROUND(FACE_AMT_DAILY,2) AS FACE_AMT_DAILY,      
       ROUND(BOOK_VALUE_MONTHLY,2) AS BOOK_VALUE_MONTHLY, ROUND(BOOK_VALUE_DAILY,2) AS BOOK_VALUE_DAILY, 
       (FACE_AMT_MONTHLY-BOOK_VALUE_MONTHLY) AS 'Prem/Disc (monthly)',
       (FACE_AMT_DAILY-BOOK_VALUE_DAILY) AS 'Prem/Disc (daily)',
       MTM_PRICE_WAVG_MONTHLY, MTM_PRICE_WAVG_DAILY, GROSS_WAC_WAVG_MONTHLY, GROSS_WAC_WAVG_DAILY,
       NET_WAC_WAVG_MONTHLY, NET_WAC_WAVG_DAILY, MARGIN_WAVG_MONTHLY, MARGIN_WAVG_DAILY,
--       ROUND(MTM_PRICE_MONTHLY,2) AS MTM_PRICE_MONTHLY, ROUND(MTM_PRICE_DAILY,2) AS MTM_PRICE_DAILY,
--       ROUND(GROSS_WAC_MONTHLY,2) AS GROSS_WAC_MONTHLY, ROUND(GROSS_WAC_DAILY,2) AS GROSS_WAC_DAILY,
--       ROUND(NET_WAC_MONTHLY,2) AS NET_WAC_MONTHLY, ROUND(NET_WAC_DAILY,2) AS NET_WAC_DAILY,
--       ROUND(MARGIN_MONTHLY,2) AS MARGIN_MONTHLY, ROUND(MARGIN_DAILY,2) AS MARGIN_DAILY,
       'DEC 2021' DATA_DATE

FROM 
(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Loans' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '01/03/2022'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Securities' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Debt' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'Derivatives' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, CAST(' ' AS int) AS BOOK_VALUE_DAILY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_DAILY,
'Daily' DATA_FREQ_DAILY,
'NMA' PRODUCT_DAILY,
QRM_ACCOUNT QRM_ACCOUNT_DAILY, SUM(FACE_AMT) FACE_AMT_DAILY, SUM(BOOK_VALUE) BOOK_VALUE_DAILY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_DAILY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_DAILY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_DAILY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_DAILY

FROM FNMA_QRM_DAILY_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) A

LEFT JOIN 

(SELECT PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Loans' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Loans_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE = '12/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Securities' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Securities_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Debt' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_DEBT_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'Derivatives' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, CAST(' ' AS int) AS BOOK_VALUE_MONTHLY,
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_Derivatives_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2021'
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT

UNION ALL

SELECT
PORTFOLIO_DATE PORTFOLIO_DATE_MONTHLY,
'MONTHLY' DATA_FREQ_MONTHLY,
'NMA' PRODUCT_MONTHLY,
QRM_ACCOUNT QRM_ACCOUNT_MONTHLY, SUM(FACE_AMT) FACE_AMT_MONTHLY, SUM(BOOK_VALUE) BOOK_VALUE_MONTHLY, 
CAST((SUM(MTM_PRICE * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MTM_PRICE_WAVG_MONTHLY, 
CAST((SUM(GROSS_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS GROSS_WAC_WAVG_MONTHLY,
CAST((SUM(NET_WAC * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS NET_WAC_WAVG_MONTHLY,
CAST((SUM(MARGIN * FACE_AMT) / NULLIF(SUM(FACE_AMT),0)) AS DECIMAL(9,2)) AS MARGIN_WAVG_MONTHLY

FROM FNMA_QRM_NMA_Stage_6_MASTER_Hist
WHERE PORTFOLIO_DATE= '12/31/2021'
AND SETTL_DATD<=PORTFOLIO_DATE
GROUP BY PORTFOLIO_DATE, QRM_ACCOUNT) B
ON A.QRM_ACCOUNT_DAILY = B.QRM_ACCOUNT_MONTHLY
AND A.PRODUCT_DAILY = B.PRODUCT_MONTHLY
